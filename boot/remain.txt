LD 							= 	x86_64-elf-ld
LD_OPTIONS					=	-melf_i386

BUILD_DIR 					= 	./build
BUILD_NAME					=	boot.bin
BUILD_BIN_NAME 				=

.PHONY: all clean

all: preBuild build postBuild

preBuild:
override BUILD_BIN_NAME = $(BUILD_DIR)/$(BUILD_NAME)

build: buildDir $(BUILD_BIN_NAME)

postBuild:
	dd if=$(BUILD_DIR)/boot.bin of=$(BUILD_DIR)/boot.bin bs=1 count=1 seek=1048575

buildDir:
	mkdir -p $(BUILD_DIR)

$(BUILD_BIN_NAME): realMode.o protectedMode.o
	$(LD) $(BUILD_DIR)/realMode.o $(BUILD_DIR)/protectedMode.o $(LD_OPTIONS) -T linker.ld -o $(BUILD_BIN_NAME)

realMode.o:
	cd realMode && $(MAKE)
	mv ./realMode/build/realMode.o $(BUILD_DIR)

protectedMode.o:
	cd protectedMode && $(MAKE)
	mv ./protectedMode/build/protectedMode.o $(BUILD_DIR)

clean:
	cd realMode && $(MAKE) clean
	cd protectedMode && $(MAKE) clean
	rm -rf $(BUILD_DIR)
