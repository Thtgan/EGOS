#include<devices/display/vga/dac.h>

#include<algorithms.h>
#include<devices/display/display.h>
#include<devices/display/vga/registers.h>
#include<devices/display/vga/vga.h>
#include<kit/bit.h>
#include<kit/types.h>
#include<memory/memory.h>
#include<real/ports/vga.h>
#include<real/simpleAsmLines.h>
#include<structs/KDtree.h>

static VGApalette _vgaPalette_color64 = {
    .colorNum = 64,
    .pelMask = 0xFF,
    .colors = {
        { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x2A }, { 0x00, 0x2A, 0x00 }, { 0x00, 0x2A, 0x2A },
        { 0x2A, 0x00, 0x00 }, { 0x2A, 0x00, 0x2A }, { 0x2A, 0x15, 0x00 }, { 0x2A, 0x2A, 0x2A },
        { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x2A }, { 0x00, 0x2A, 0x00 }, { 0x00, 0x2A, 0x2A },
        { 0x2A, 0x00, 0x00 }, { 0x2A, 0x00, 0x2A }, { 0x2A, 0x15, 0x00 }, { 0x2A, 0x2A, 0x2A },
        { 0x15, 0x15, 0x15 }, { 0x15, 0x15, 0x3F }, { 0x15, 0x3F, 0x15 }, { 0x15, 0x3F, 0x3F },
        { 0x3F, 0x15, 0x15 }, { 0x3F, 0x15, 0x3F }, { 0x3F, 0x3F, 0x15 }, { 0x3F, 0x3F, 0x3F },
        { 0x15, 0x15, 0x15 }, { 0x15, 0x15, 0x3F }, { 0x15, 0x3F, 0x15 }, { 0x15, 0x3F, 0x3F },
        { 0x3F, 0x15, 0x15 }, { 0x3F, 0x15, 0x3F }, { 0x3F, 0x3F, 0x15 }, { 0x3F, 0x3F, 0x3F },
        { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x2A }, { 0x00, 0x2A, 0x00 }, { 0x00, 0x2A, 0x2A },
        { 0x2A, 0x00, 0x00 }, { 0x2A, 0x00, 0x2A }, { 0x2A, 0x15, 0x00 }, { 0x2A, 0x2A, 0x2A },
        { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x2A }, { 0x00, 0x2A, 0x00 }, { 0x00, 0x2A, 0x2A },
        { 0x2A, 0x00, 0x00 }, { 0x2A, 0x00, 0x2A }, { 0x2A, 0x15, 0x00 }, { 0x2A, 0x2A, 0x2A },
        { 0x15, 0x15, 0x15 }, { 0x15, 0x15, 0x3F }, { 0x15, 0x3F, 0x15 }, { 0x15, 0x3F, 0x3F },
        { 0x3F, 0x15, 0x15 }, { 0x3F, 0x15, 0x3F }, { 0x3F, 0x3F, 0x15 }, { 0x3F, 0x3F, 0x3F },
        { 0x15, 0x15, 0x15 }, { 0x15, 0x15, 0x3F }, { 0x15, 0x3F, 0x15 }, { 0x15, 0x3F, 0x3F },
        { 0x3F, 0x15, 0x15 }, { 0x3F, 0x15, 0x3F }, { 0x3F, 0x3F, 0x15 }, { 0x3F, 0x3F, 0x3F }
    }
};

static VGApalette _vgaPalette_color256 = {
    .colorNum = 256,
    .pelMask = 0xFF,
    .colors = {
        { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x2A }, { 0x00, 0x2A, 0x00 }, { 0x00, 0x2A, 0x2A },
        { 0x2A, 0x00, 0x00 }, { 0x2A, 0x00, 0x2A }, { 0x2A, 0x15, 0x00 }, { 0x2A, 0x2A, 0x2A },
        { 0x15, 0x15, 0x15 }, { 0x15, 0x15, 0x3F }, { 0x15, 0x3F, 0x15 }, { 0x15, 0x3F, 0x3F },
        { 0x3F, 0x15, 0x15 }, { 0x3F, 0x15, 0x3F }, { 0x3F, 0x3F, 0x15 }, { 0x3F, 0x3F, 0x3F },
        { 0x00, 0x00, 0x00 }, { 0x05, 0x05, 0x05 }, { 0x08, 0x08, 0x08 }, { 0x0B, 0x0B, 0x0B },
        { 0x0E, 0x0E, 0x0E }, { 0x11, 0x11, 0x11 }, { 0x14, 0x14, 0x14 }, { 0x18, 0x18, 0x18 },
        { 0x1C, 0x1C, 0x1C }, { 0x20, 0x20, 0x20 }, { 0x24, 0x24, 0x24 }, { 0x28, 0x28, 0x28 },
        { 0x2D, 0x2D, 0x2D }, { 0x32, 0x32, 0x32 }, { 0x38, 0x38, 0x38 }, { 0x3F, 0x3F, 0x3F },
        { 0x00, 0x00, 0x3F }, { 0x10, 0x00, 0x3F }, { 0x1F, 0x00, 0x3F }, { 0x2F, 0x00, 0x3F },
        { 0x3F, 0x00, 0x3F }, { 0x3F, 0x00, 0x2F }, { 0x3F, 0x00, 0x1F }, { 0x3F, 0x00, 0x10 },
        { 0x3F, 0x00, 0x00 }, { 0x3F, 0x10, 0x00 }, { 0x3F, 0x1F, 0x00 }, { 0x3F, 0x2F, 0x00 },
        { 0x3F, 0x3F, 0x00 }, { 0x2F, 0x3F, 0x00 }, { 0x1F, 0x3F, 0x00 }, { 0x10, 0x3F, 0x00 },
        { 0x00, 0x3F, 0x00 }, { 0x00, 0x3F, 0x10 }, { 0x00, 0x3F, 0x1F }, { 0x00, 0x3F, 0x2F },
        { 0x00, 0x3F, 0x3F }, { 0x00, 0x2F, 0x3F }, { 0x00, 0x1F, 0x3F }, { 0x00, 0x10, 0x3F },
        { 0x1F, 0x1F, 0x3F }, { 0x27, 0x1F, 0x3F }, { 0x2F, 0x1F, 0x3F }, { 0x37, 0x1F, 0x3F },
        { 0x3F, 0x1F, 0x3F }, { 0x3F, 0x1F, 0x37 }, { 0x3F, 0x1F, 0x2F }, { 0x3F, 0x1F, 0x27 },

        { 0x3F, 0x1F, 0x1F }, { 0x3F, 0x27, 0x1F }, { 0x3F, 0x2F, 0x1F }, { 0x3F, 0x37, 0x1F },
        { 0x3F, 0x3F, 0x1F }, { 0x37, 0x3F, 0x1F }, { 0x2F, 0x3F, 0x1F }, { 0x27, 0x3F, 0x1F },
        { 0x1F, 0x3F, 0x1F }, { 0x1F, 0x3F, 0x27 }, { 0x1F, 0x3F, 0x2F }, { 0x1F, 0x3F, 0x37 },
        { 0x1F, 0x3F, 0x3F }, { 0x1F, 0x37, 0x3F }, { 0x1F, 0x2F, 0x3F }, { 0x1F, 0x27, 0x3F },
        { 0x2D, 0x2D, 0x3F }, { 0x31, 0x2D, 0x3F }, { 0x36, 0x2D, 0x3F }, { 0x3A, 0x2D, 0x3F },
        { 0x3F, 0x2D, 0x3F }, { 0x3F, 0x2D, 0x3A }, { 0x3F, 0x2D, 0x36 }, { 0x3F, 0x2D, 0x31 },
        { 0x3F, 0x2D, 0x2D }, { 0x3F, 0x31, 0x2D }, { 0x3F, 0x36, 0x2D }, { 0x3F, 0x3A, 0x2D },
        { 0x3F, 0x3F, 0x2D }, { 0x3A, 0x3F, 0x2D }, { 0x36, 0x3F, 0x2D }, { 0x31, 0x3F, 0x2D },
        { 0x2D, 0x3F, 0x2D }, { 0x2D, 0x3F, 0x31 }, { 0x2D, 0x3F, 0x36 }, { 0x2D, 0x3F, 0x3A },
        { 0x2D, 0x3F, 0x3F }, { 0x2D, 0x3A, 0x3F }, { 0x2D, 0x36, 0x3F }, { 0x2D, 0x31, 0x3F },
        { 0x00, 0x00, 0x1C }, { 0x07, 0x00, 0x1C }, { 0x0E, 0x00, 0x1C }, { 0x15, 0x00, 0x1C },
        { 0x1C, 0x00, 0x1C }, { 0x1C, 0x00, 0x15 }, { 0x1C, 0x00, 0x0E }, { 0x1C, 0x00, 0x07 },
        { 0x1C, 0x00, 0x00 }, { 0x1C, 0x07, 0x00 }, { 0x1C, 0x0E, 0x00 }, { 0x1C, 0x15, 0x00 },
        { 0x1C, 0x1C, 0x00 }, { 0x15, 0x1C, 0x00 }, { 0x0E, 0x1C, 0x00 }, { 0x07, 0x1C, 0x00 },
        { 0x00, 0x1C, 0x00 }, { 0x00, 0x1C, 0x07 }, { 0x00, 0x1C, 0x0E }, { 0x00, 0x1C, 0x15 },
        { 0x00, 0x1C, 0x1C }, { 0x00, 0x15, 0x1C }, { 0x00, 0x0E, 0x1C }, { 0x00, 0x07, 0x1C },

        { 0x0E, 0x0E, 0x1C }, { 0x11, 0x0E, 0x1C }, { 0x15, 0x0E, 0x1C }, { 0x18, 0x0E, 0x1C },
        { 0x1C, 0x0E, 0x1C }, { 0x1C, 0x0E, 0x18 }, { 0x1C, 0x0E, 0x15 }, { 0x1C, 0x0E, 0x11 },
        { 0x1C, 0x0E, 0x0E }, { 0x1C, 0x11, 0x0E }, { 0x1C, 0x15, 0x0E }, { 0x1C, 0x18, 0x0E },
        { 0x1C, 0x1C, 0x0E }, { 0x18, 0x1C, 0x0E }, { 0x15, 0x1C, 0x0E }, { 0x11, 0x1C, 0x0E },
        { 0x0E, 0x1C, 0x0E }, { 0x0E, 0x1C, 0x11 }, { 0x0E, 0x1C, 0x15 }, { 0x0E, 0x1C, 0x18 },
        { 0x0E, 0x1C, 0x1C }, { 0x0E, 0x18, 0x1C }, { 0x0E, 0x15, 0x1C }, { 0x0E, 0x11, 0x1C },
        { 0x14, 0x14, 0x1C }, { 0x16, 0x14, 0x1C }, { 0x18, 0x14, 0x1C }, { 0x1A, 0x14, 0x1C },
        { 0x1C, 0x14, 0x1C }, { 0x1C, 0x14, 0x1A }, { 0x1C, 0x14, 0x18 }, { 0x1C, 0x14, 0x16 },
        { 0x1C, 0x14, 0x14 }, { 0x1C, 0x16, 0x14 }, { 0x1C, 0x18, 0x14 }, { 0x1C, 0x1A, 0x14 },
        { 0x1C, 0x1C, 0x14 }, { 0x1A, 0x1C, 0x14 }, { 0x18, 0x1C, 0x14 }, { 0x16, 0x1C, 0x14 },
        { 0x14, 0x1C, 0x14 }, { 0x14, 0x1C, 0x16 }, { 0x14, 0x1C, 0x18 }, { 0x14, 0x1C, 0x1A },
        { 0x14, 0x1C, 0x1C }, { 0x14, 0x1A, 0x1C }, { 0x14, 0x18, 0x1C }, { 0x14, 0x16, 0x1C },
        { 0x00, 0x00, 0x10 }, { 0x04, 0x00, 0x10 }, { 0x08, 0x00, 0x10 }, { 0x0C, 0x00, 0x10 },
        { 0x10, 0x00, 0x10 }, { 0x10, 0x00, 0x0C }, { 0x10, 0x00, 0x08 }, { 0x10, 0x00, 0x04 },
        { 0x10, 0x00, 0x00 }, { 0x10, 0x04, 0x00 }, { 0x10, 0x08, 0x00 }, { 0x10, 0x0C, 0x00 },
        { 0x10, 0x10, 0x00 }, { 0x0C, 0x10, 0x00 }, { 0x08, 0x10, 0x00 }, { 0x04, 0x10, 0x00 },

        { 0x00, 0x10, 0x00 }, { 0x00, 0x10, 0x04 }, { 0x00, 0x10, 0x08 }, { 0x00, 0x10, 0x0C },
        { 0x00, 0x10, 0x10 }, { 0x00, 0x0C, 0x10 }, { 0x00, 0x08, 0x10 }, { 0x00, 0x04, 0x10 },
        { 0x08, 0x08, 0x10 }, { 0x0A, 0x08, 0x10 }, { 0x0C, 0x08, 0x10 }, { 0x0E, 0x08, 0x10 },
        { 0x10, 0x08, 0x10 }, { 0x10, 0x08, 0x0E }, { 0x10, 0x08, 0x0C }, { 0x10, 0x08, 0x0A },
        { 0x10, 0x08, 0x08 }, { 0x10, 0x0A, 0x08 }, { 0x10, 0x0C, 0x08 }, { 0x10, 0x0E, 0x08 },
        { 0x10, 0x10, 0x08 }, { 0x0E, 0x10, 0x08 }, { 0x0C, 0x10, 0x08 }, { 0x0A, 0x10, 0x08 },
        { 0x08, 0x10, 0x08 }, { 0x08, 0x10, 0x0A }, { 0x08, 0x10, 0x0C }, { 0x08, 0x10, 0x0E },
        { 0x08, 0x10, 0x10 }, { 0x08, 0x0E, 0x10 }, { 0x08, 0x0C, 0x10 }, { 0x08, 0x0A, 0x10 },
        { 0x0B, 0x0B, 0x10 }, { 0x0C, 0x0B, 0x10 }, { 0x0D, 0x0B, 0x10 }, { 0x0F, 0x0B, 0x10 },
        { 0x10, 0x0B, 0x10 }, { 0x10, 0x0B, 0x0F }, { 0x10, 0x0B, 0x0D }, { 0x10, 0x0B, 0x0C },
        { 0x10, 0x0B, 0x0B }, { 0x10, 0x0C, 0x0B }, { 0x10, 0x0D, 0x0B }, { 0x10, 0x0F, 0x0B },
        { 0x10, 0x10, 0x0B }, { 0x0F, 0x10, 0x0B }, { 0x0D, 0x10, 0x0B }, { 0x0C, 0x10, 0x0B },
        { 0x0B, 0x10, 0x0B }, { 0x0B, 0x10, 0x0C }, { 0x0B, 0x10, 0x0D }, { 0x0B, 0x10, 0x0F },
        { 0x0B, 0x10, 0x10 }, { 0x0B, 0x0F, 0x10 }, { 0x0B, 0x0D, 0x10 }, { 0x0B, 0x0C, 0x10 },
        { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x00 },
        { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x00 }, { 0x00, 0x00, 0x00 }
    }
};

static VGApalette* _vgaPalettes[VGA_PALETTE_TYPE_NUM] = {
    [VGA_PALETTE_TYPE_COLOR_64]     = &_vgaPalette_color64,
    [VGA_PALETTE_TYPE_COLOR_256]    = &_vgaPalette_color256
};

//TODO: Ugly codes
static inline Object __vgaPalette_dacColorToKey(VGAcolor vgaColorIndex, VGAdacColor* dacColor) {
    return (Object)dacColor->r | VAL_LEFT_SHIFT((Object)dacColor->g, 8) | VAL_LEFT_SHIFT((Object)dacColor->b, 16) | VAL_LEFT_SHIFT((Object)vgaColorIndex, 24);
}

static inline Object __vgaPalette_rgbaToKey(RGBA color) {
    return VAL_RIGHT_SHIFT(TRIM_VAL(color, 0x00FCFCFC), 2);
}

static inline RGBA __vgaPalette_keyToRGBA(Object key) {
    return VAL_LEFT_SHIFT(TRIM_VAL_SIMPLE(key, 32, 24), 2) | 0xFF000000;
}

static inline VGAcolor __vgaPalette_keyToVGAcolor(Object key) {
    return EXTRACT_VAL(key, 64, 24, 32);
}

int __vgaPalette_colorCompare(Object o1, Object o2, int offset, int round);

Uint64 __vgaPalette_colorDistance(Object o1, Object o2);

int __vgaPalette_colorGrayScaleCompare(const Object o1, const Object o2);

OldResult __vgaPalette_registerKey(VGApalette* palette, Object key);

OldResult vgaPalette_initApproximate(VGApalette* palette) {
    Object grayScaleSortedColor[256];
    for (int i = 0; i < palette->colorNum; ++i) {
        VGAdacColor* dacColor = &palette->colors[i];
        grayScaleSortedColor[i] = __vgaPalette_dacColorToKey(i, dacColor);
    }

    algorithms_quickSort(grayScaleSortedColor, palette->colorNum, __vgaPalette_colorGrayScaleCompare);

    KDtree_initStruct(&palette->colorApproximate, 3, __vgaPalette_colorCompare, __vgaPalette_colorDistance);

    int i, j;
    for (i = palette->colorNum >> 1, j = i - 1; i < palette->colorNum, j >= 0; ++i, --j) {
        if (__vgaPalette_registerKey(palette, grayScaleSortedColor[i]) == RESULT_ERROR) {
            return RESULT_ERROR;
        }

        if (__vgaPalette_registerKey(palette, grayScaleSortedColor[j]) == RESULT_ERROR) {
            return RESULT_ERROR;
        }
    }

    for (; i < palette->colorNum; ++i) {
        if (__vgaPalette_registerKey(palette, grayScaleSortedColor[i]) == RESULT_ERROR) {
            return RESULT_ERROR;
        }
    }

    for (; j >= 0; --j) {
        if (__vgaPalette_registerKey(palette, grayScaleSortedColor[j]) == RESULT_ERROR) {
            return RESULT_ERROR;
        }
    }

    return RESULT_SUCCESS;
}

VGAcolor vgaPalette_approximateColor(VGApalette* palette, RGBA color) {
    Object key = __vgaPalette_rgbaToKey(color), closestKey = OBJECT_NULL;
    if (KDtree_nearestNeighbour(&palette->colorApproximate, key, &closestKey) != RESULT_SUCCESS) {
        return 0;
    }

    return __vgaPalette_keyToVGAcolor(closestKey);
}

RGBA vgaPalette_vgaColorToRGBA(VGApalette* palette, VGAcolor color) {
    if (color >= palette->colorNum) {
        return 0;
    }
    
    VGAdacColor* dacColor = &palette->colors[color];
    return display_buildRGBA(dacColor->r, dacColor->g, dacColor->b, 0xFF);
}

OldResult vgaColorConverter_initStruct(VGAcolorConverter* converter, VGAhardwareRegisters* registers, VGApalette* palette) {
    for (int i = 0; i < 16; ++i) {
        VGAcolor color = registers->attributeControllerRegisters.data[i];    //Internal palette i
        VGAdacColor* dacColor = &palette->colors[color];
        Object dacKey = __vgaPalette_dacColorToKey(i, dacColor);

        KDtreeNode* existingKey = KDtree_search(&palette->colorApproximate, dacKey);
        if (existingKey == NULL) {
            return RESULT_ERROR;
        }

        converter->convertData[i] = __vgaPalette_keyToVGAcolor(existingKey->key);
    }

    return RESULT_SUCCESS;
}

VGAcolor vgaColorConverter_convert(VGAcolorConverter* converter, VGAcolor color) {
    VGAcolor ret = 0;
    for (int i = 1; i < 16; ++i) {
        if (converter->convertData[i] == color) {
            ret = i;
            break;
        }
    }

    return ret;
}

OldResult vgaPalettes_init() {
    for (int i = 0; i < VGA_PALETTE_TYPE_NUM; ++i) {
        if (vgaPalette_initApproximate(_vgaPalettes[i]) != RESULT_SUCCESS) {
            return RESULT_ERROR;
        }
    }

    return RESULT_SUCCESS;
}

void vgaDAC_readColors(Index8 begin, VGAdacColor* colors, Size n) {
    outb(VGA_DAC_INDEX_READ, begin);
    while (n--) {
        colors->r = inb(VGA_DAC_PALETTE_DATA);
        colors->g = inb(VGA_DAC_PALETTE_DATA);
        colors->b = inb(VGA_DAC_PALETTE_DATA);
        ++colors;
    }
}

void vgaDAC_writeColors(Index8 begin, const VGAdacColor* colors, Size n) {
    outb(VGA_DAC_INDEX_WRITE, begin);
    while (n--) {
        outb(VGA_DAC_PALETTE_DATA, colors->r);
        outb(VGA_DAC_PALETTE_DATA, colors->g);
        outb(VGA_DAC_PALETTE_DATA, colors->b);
        ++colors;
    }
}

void vgaDAC_readPalette(VGApalette* palette, Size colorN) {
    palette->colorNum = colorN;
    vgaDAC_readColors(0, palette->colors, colorN);
    memory_memset(&palette->colors[colorN], 0, sizeof(palette->colors) - colorN * sizeof(VGAdacColor));
    palette->pelMask = 0xFF;
}

void vgaDAC_writePalette(VGApalette* palette) {
    vgaHardwareRegisters_writeDACpelMask(palette->pelMask);
    vgaDAC_writeColors(0, palette->colors, 256);
}

VGApalette* vgaDAC_getPalette(VGApaletteType type) {
    return type >= VGA_PALETTE_TYPE_NUM ? NULL : _vgaPalettes[type];
}

int __vgaPalette_colorCompare(Object o1, Object o2, int offset, int round) {
    int begin = 8 * round, end = 8 * (round + 1);
    int v1 = EXTRACT_VAL(o1, 64, begin, end), v2 = EXTRACT_VAL(o2, 64, begin, end);

    return v1 + offset - v2;
}

Uint64 __vgaPalette_colorDistance(Object o1, Object o2) {
    Uint64 ret = 0;
    for (int i = 0; i < 3; ++i, o1 >>= 8, o2 >>= 8) {
        Int16 v1 = TRIM_VAL_SIMPLE(o1, 64, 8), v2 = TRIM_VAL_SIMPLE(o2, 64, 8);
        ret += (v1 - v2) * (v1 - v2);
    }

    return ret;
}

int __vgaPalette_colorGrayScaleCompare(const Object o1, const Object o2) {
    return (int)display_rgbToGrayScale(__vgaPalette_keyToRGBA(o1)) - (int)display_rgbToGrayScale(__vgaPalette_keyToRGBA(o2));
}

OldResult __vgaPalette_registerKey(VGApalette* palette, Object key) {
    if (KDtree_search(&palette->colorApproximate, key) != NULL) {
        return RESULT_CONTINUE;
    }

    KDtreeNode* node = memory_allocate(sizeof(KDtreeNode));
    if (node == NULL) {
        return RESULT_ERROR;
    }

    KDtreeNode_initStruct(node, key);
    KDtree_insert(&palette->colorApproximate, node);

    return RESULT_SUCCESS;
}